"use strict";var WORLD_SIDE_SIZE=7,WINDOW_HEIGHT=window.innerHeight,WINDOW_WIDTH=window.innerWidth,ROAD_COLORS=[16711680,16746496,16776960,65280,65535,255,16711935],NUMBER_COLORS=ROAD_COLORS.length,WORLD_HEIGHT=1e3,WORLD_WIDTH=100,TOP_CAMERA_DIST=50,CAR_SIZE_X=10,CAR_SIZE_Y=10,CAR_SIZE_Z=10,BOX_SIZE=10,Physics=function(){var e=-1,o=new THREE.Vector3(0,-TOP_CAMERA_DIST,0),t=new THREE.Vector3(0,1,0),n=new THREE.Raycaster;return{gravity:function(i,r){o.x=i.position.x,o.z=i.position.z,n.set(o,t),(!n.intersectObject(r,!0).length||i.position.y<0)&&(i.position.y+=e)},detectCollision:function(e,o){for(var t=(new THREE.Box3).setFromObject(e),n=0;n<o.length;n++)if(t.intersectsBox(o[n].boundingBox))return!0;return!1}}}(),Box=function(e,o,t){var n=new THREE.BoxGeometry(BOX_SIZE,BOX_SIZE,BOX_SIZE),i=new THREE.MeshBasicMaterial({color:11176004});this.mesh=new THREE.Mesh(n,i),this.mesh.position.x=e,this.mesh.position.y=o,this.mesh.position.z=t,this.boundingBox=(new THREE.Box3).setFromObject(this.mesh)},Player=function(){function e(e){e=e||event,d[e.which]="keydown"===e.type}var o=new THREE.PerspectiveCamera(75,WINDOW_WIDTH/WINDOW_HEIGHT,.1,1e3),t=new THREE.PerspectiveCamera(75,WINDOW_WIDTH/WINDOW_HEIGHT,.1,1e3),n=t,i=function(){var e=(new THREE.ObjectLoader).parse(playerCar);return o.position.y=2*e.scale.y,o.position.z=4*e.scale.z,o.rotateY(180*Math.PI/180),t.position.y=10*e.scale.y,t.position.z=-20*e.scale.z,t.rotateY(180*Math.PI/180),e.add(o),e.add(t),e}(),r={movement:{arrows:{up:38,down:40,left:37,right:39},wasd:{up:87,down:83,left:65,right:68}},switchCamera:67,reset:8},a=r.movement.arrows,s=0,c=5,E=.05,l=.05,d={};return document.addEventListener("keydown",e,!1),document.addEventListener("keyup",e,!1),{doMovementLoop:function(){d[a.up]&&s<c&&(s+=E),d[a.left]&&i.rotateY(l),d[a.right]&&i.rotateY(-l),d[a.down]&&s>0&&(s-=E,s=Math.max(0,s)),i.translateZ(s),d[r.switchCamera]&&(n=n===o?t:o,d[r.switchCamera]=!1),d[r.reset]&&(i.rotation.x=0,i.position.set(0,i.position.x,0),i.rotation.y=0,i.position.set(0,i.position.y,0),i.rotation.z=0,i.position.set(0,i.position.z,0))},playerObject:i,getCamera:function(){return n},playerId:null,crash:function(){s=0}}}(),NotMarioKart=function(){function e(){var e=io({transports:["websocket"],upgrade:!1});e.on("all-players",function(t){console.log("[all-players]",t),t.forEach(function(e){var t=e.position,n=e.rotation,i=o();p[e.id]={position:t,rotation:n,car:i},i.position.set(t.x,t.y,t.z),i.rotation.set(n.x,n.y,n.z),s.add(i)}),console.log(t),0==t.length&&(n(),e.emit("send-boxes",h))}),e.on("player-joined",function(e){toastr.success("player "+e.id+" has joined."),console.log("[player-joined]",e);var t=e.position,n=e.rotation,i=o();p[e.id]={position:t,rotation:n,car:i},i.position.set(t.x,t.y,t.z),i.rotation.set(n.x,n.y,n.z),s.add(i)}),e.on("receive-boxes",function(e){h=e,i()}),e.on("player-left",function(e){toastr.error("Player "+e+" has left."),console.log("[player-left]",e);var o=p[e].car;s.remove(o),delete p[e]}),e.on("update-player",function(e){console.log("[update-player]",e);var o=e.id,t=e.position,n=e.rotation,i=p[o];i.car.position.set(t.x,t.y,t.z),i.car.rotation.set(n.x,n.y,n.z)}),e.on("start-countdown",function(e){toastr.info(e+" seconds before the race starts."),console.log("[start-countdown]",e)}),e.on("start",function(){toastr.info("The race has started."),console.log("[start]")}),e.on("finished",function(e){toastr.info("You finished."),console.log("[finished]",e)}),e.on("stop",function(e){toaster.info("The race is over."),console.log("[stop]",stop),e.forEach(function(e){e.name})}),window.setInterval(function(){var o=Player.playerObject;e.emit("update-player",{position:{x:o.position.x,y:o.position.y,z:o.position.z},rotation:{x:o.rotation._x,y:o.rotation._y,z:o.rotation._z}})},40)}function o(){return(new THREE.ObjectLoader).parse(playerCar)}function t(){var e=new THREE.CatmullRomCurve3([new THREE.Vector3(0,0,0),new THREE.Vector3(0,500,0),new THREE.Vector3(-200,500,0),new THREE.Vector3(-200,800,0),new THREE.Vector3(600,800,0),new THREE.Vector3(600,500,0),new THREE.Vector3(300,500,0),new THREE.Vector3(300,0,0),new THREE.Vector3(800,0,0),new THREE.Vector3(800,-500,0),new THREE.Vector3(0,-500,0)]);e.closed=!0;for(var o={steps:100,extrudePath:e},t=new THREE.Shape([new THREE.Vector2(2*CAR_SIZE_Y,0),new THREE.Vector2(0,5*CAR_SIZE_X),new THREE.Vector2(0,-5*CAR_SIZE_X)]),n=new THREE.ExtrudeGeometry(t,o),i=[],r=0;r<NUMBER_COLORS;r++)i.push(new THREE.MeshBasicMaterial({color:ROAD_COLORS[r],side:THREE.DoubleSide}));for(var c=n.faces.length/2,E=0;E<c;E++){var l=2*E;n.faces[l].materialIndex=(E+Math.floor(E/WORLD_SIDE_SIZE))%NUMBER_COLORS,n.faces[l+1].materialIndex=(E+Math.floor(E/WORLD_SIDE_SIZE))%NUMBER_COLORS}(a=new THREE.Mesh(n,i)).rotateX(-Math.PI/2),a.position.y=0,s.add(a)}function n(){for(var e=0;e<1e3;e++){var o=new Box(Math.floor(4001*Math.random()-2e3),BOX_SIZE/2,Math.floor(4001*Math.random()-2e3));s.updateMatrixWorld(),Physics.gravity(o.mesh,a),o.mesh.position.y==BOX_SIZE/2&&(d.push(o),h.push({x:o.mesh.position.x,z:o.mesh.position.z}),s.add(o.mesh))}}function i(){for(var e=0;e<h.length;e++){var o=new Box(h[e].x,BOX_SIZE/2,h[e].z);s.updateMatrixWorld(),Physics.gravity(o.mesh,a),o.mesh.position.y==BOX_SIZE/2&&(d.push(o),s.add(o.mesh))}}function r(){requestAnimationFrame(r),c.clear(),c.setViewport(0,0,WINDOW_WIDTH,WINDOW_HEIGHT),c.render(s,Player.getCamera()),E.clear(),E.setViewport(0,0,WINDOW_WIDTH/4,WINDOW_HEIGHT/4),E.render(s,l),Player.doMovementLoop(),Physics.detectCollision(Player.playerObject,d)&&Player.crash(),l.position.z=Player.playerObject.position.z,Physics.gravity(Player.playerObject,a)}var a,s=new THREE.Scene,c=new THREE.WebGLRenderer,E=new THREE.WebGLRenderer,l=new THREE.OrthographicCamera(-WINDOW_WIDTH,WINDOW_WIDTH,WINDOW_HEIGHT,-WINDOW_HEIGHT,TOP_CAMERA_DIST-50,TOP_CAMERA_DIST+50),d=[],p={},h=[];return{init:function(){c.setSize(WINDOW_WIDTH,WINDOW_HEIGHT),c.setPixelRatio(window.devicePixelRatio),c.domElement.style.position="fixed",document.body.appendChild(c.domElement),c.autoClear=!1,E.setSize(WINDOW_WIDTH/4,WINDOW_HEIGHT/4),E.setPixelRatio(window.devicePixelRatio),E.domElement.style.position="fixed",E.domElement.style.top="5%",E.domElement.style.left="70%",E.domElement.style.zIndex="2",E.domElement.style.outline="white solid",document.body.appendChild(E.domElement),E.autoClear=!1,l.position.y=TOP_CAMERA_DIST,l.rotation.x=-90*Math.PI/180,t(),s.add(Player.playerObject),e(),r()}}}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnN0YW50cy5qcyIsIlBoeXNpY3MuanMiLCJCb3guanMiLCJQbGF5ZXIuanMiLCJOb3RNYXJpb0thcnQuanMiXSwibmFtZXMiOlsiV09STERfU0lERV9TSVpFIiwiV0lORE9XX0hFSUdIVCIsIndpbmRvdyIsImlubmVySGVpZ2h0IiwiV0lORE9XX1dJRFRIIiwiaW5uZXJXaWR0aCIsIlJPQURfQ09MT1JTIiwiTlVNQkVSX0NPTE9SUyIsImxlbmd0aCIsIldPUkxEX0hFSUdIVCIsIldPUkxEX1dJRFRIIiwiVE9QX0NBTUVSQV9ESVNUIiwiQ0FSX1NJWkVfWCIsIkNBUl9TSVpFX1kiLCJDQVJfU0laRV9aIiwiQk9YX1NJWkUiLCJQaHlzaWNzIiwiZyIsImhlbGwiLCJUSFJFRSIsIlZlY3RvcjMiLCJvbmVEaXJlY3Rpb24iLCJyYXljYXN0ZXIiLCJSYXljYXN0ZXIiLCJncmF2aXR5Iiwib2JqZWN0IiwiZmxvb3IiLCJ4IiwicG9zaXRpb24iLCJ6Iiwic2V0IiwiaW50ZXJzZWN0T2JqZWN0IiwieSIsImRldGVjdENvbGxpc2lvbiIsImNhciIsIm9iamVjdHMiLCJjYXJCb3giLCJCb3gzIiwic2V0RnJvbU9iamVjdCIsImkiLCJpbnRlcnNlY3RzQm94IiwiYm91bmRpbmdCb3giLCJCb3giLCJnZW9tZXRyeSIsIkJveEdlb21ldHJ5IiwibWF0ZXJpYWwiLCJNZXNoQmFzaWNNYXRlcmlhbCIsImNvbG9yIiwidGhpcyIsIm1lc2giLCJNZXNoIiwiUGxheWVyIiwib25LZXlNb3ZlIiwiZSIsImV2ZW50Iiwia2V5Q29kZU1hcCIsIndoaWNoIiwidHlwZSIsInBvdkNhbWVyYSIsIlBlcnNwZWN0aXZlQ2FtZXJhIiwidHJhY2tpbmdDYW1lcmEiLCJjdXJyZW50Q2FtZXJhIiwicGxheWVyT2JqZWN0IiwiT2JqZWN0TG9hZGVyIiwicGFyc2UiLCJwbGF5ZXJDYXIiLCJzY2FsZSIsInJvdGF0ZVkiLCJNYXRoIiwiUEkiLCJhZGQiLCJtYWtlUGxheWVyT2JqZWN0IiwiY29udHJvbHMiLCJtb3ZlbWVudCIsImFycm93cyIsInVwIiwiZG93biIsImxlZnQiLCJyaWdodCIsIndhc2QiLCJzd2l0Y2hDYW1lcmEiLCJyZXNldCIsImVuYWJsZWRDb250cm9scyIsInNwZWVkIiwibWF4U3BlZWQiLCJhY2NlbGVyYXRpb24iLCJyb3RhdGlvblNwZWVkIiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZG9Nb3ZlbWVudExvb3AiLCJtYXgiLCJ0cmFuc2xhdGVaIiwicm90YXRpb24iLCJnZXRDYW1lcmEiLCJwbGF5ZXJJZCIsImNyYXNoIiwiTm90TWFyaW9LYXJ0IiwiaW5pdFNvY2tldEV2ZW50Iiwic29ja2V0IiwiaW8iLCJ0cmFuc3BvcnRzIiwidXBncmFkZSIsIm9uIiwiZGF0YSIsImNvbnNvbGUiLCJsb2ciLCJmb3JFYWNoIiwicGxheWVyIiwicG9zIiwicm90IiwibWFrZUNhck9iamVjdCIsInBsYXllcnMiLCJpZCIsInNjZW5lIiwiYWRkQm94ZXMiLCJlbWl0IiwiYm94ZXMiLCJ0b2FzdHIiLCJzdWNjZXNzIiwiYm94cyIsImFkZEJveGVzUG9zaXRpb24iLCJlcnJvciIsInJlbW92ZSIsInAiLCJzZWNvbmRzIiwiaW5mbyIsInRpbWUiLCJ0b2FzdGVyIiwic3RvcCIsIm5hbWUiLCJzZXRJbnRlcnZhbCIsIl94IiwiX3kiLCJfeiIsImJ1aWxkRmxvb3IiLCJjdXJ2ZSIsIkNhdG11bGxSb21DdXJ2ZTMiLCJjbG9zZWQiLCJleHRydWRlU2V0dGluZ3MiLCJzdGVwcyIsImV4dHJ1ZGVQYXRoIiwic2hhcGUiLCJTaGFwZSIsIlZlY3RvcjIiLCJFeHRydWRlR2VvbWV0cnkiLCJtYXRlcmlhbHMiLCJwdXNoIiwic2lkZSIsIkRvdWJsZVNpZGUiLCJnZW9GYWNlc0xlbmd0aCIsImZhY2VzIiwiaiIsIm1hdGVyaWFsSW5kZXgiLCJyb3RhdGVYIiwiYm94IiwicmFuZG9tIiwidXBkYXRlTWF0cml4V29ybGQiLCJsb29wIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicmVuZGVyZXIiLCJjbGVhciIsInNldFZpZXdwb3J0IiwicmVuZGVyIiwibWluaU1hcFJlbmRlcmVyIiwibWluaU1hcENhbWVyYSIsIlNjZW5lIiwiV2ViR0xSZW5kZXJlciIsIk9ydGhvZ3JhcGhpY0NhbWVyYSIsImluaXQiLCJzZXRTaXplIiwic2V0UGl4ZWxSYXRpbyIsImRldmljZVBpeGVsUmF0aW8iLCJkb21FbGVtZW50Iiwic3R5bGUiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJhdXRvQ2xlYXIiLCJ0b3AiLCJ6SW5kZXgiLCJvdXRsaW5lIl0sIm1hcHBpbmdzIjoiYUFJQSxJQUFNQSxnQkFBa0IsRUFDbEJDLGNBQWdCQyxPQUFPQyxZQUN2QkMsYUFBZUYsT0FBT0csV0FDdEJDLGFBQ0YsU0FDQSxTQUNBLFNBQ0EsTUFDQSxNQUNBLElBQ0EsVUFFRUMsY0FBZ0JELFlBQVlFLE9BQzVCQyxhQUFlLElBQ2ZDLFlBQWMsSUFDZEMsZ0JBQWtCLEdBQ2xCQyxXQUFhLEdBQ2JDLFdBQWEsR0FDYkMsV0FBYSxHQUNiQyxTQUFXLEdDbkJYQyxRQUFXLFdBRWIsSUFBTUMsR0FBSyxFQUNQQyxFQUFPLElBQUlDLE1BQU1DLFFBQVEsR0FBSVQsZ0JBQWlCLEdBQzlDVSxFQUFlLElBQUlGLE1BQU1DLFFBQVEsRUFBRyxFQUFHLEdBQ3ZDRSxFQUFZLElBQUlILE1BQU1JLFVBeUIxQixPQUNJQyxRQXhCSixTQUFpQkMsRUFBUUMsR0FFckJSLEVBQUtTLEVBQUlGLEVBQU9HLFNBQVNELEVBQ3pCVCxFQUFLVyxFQUFJSixFQUFPRyxTQUFTQyxFQUN6QlAsRUFBVVEsSUFBSVosRUFBTUcsS0FHSEMsRUFBVVMsZ0JBQWdCTCxHQUFPLEdBQ2xDbEIsUUFBVWlCLEVBQU9HLFNBQVNJLEVBQUksS0FDMUNQLEVBQU9HLFNBQVNJLEdBQUtmLElBZ0J6QmdCLGdCQVpKLFNBQXlCQyxFQUFLQyxHQUUxQixJQUFLLElBRERDLEdBQVMsSUFBSWpCLE1BQU1rQixNQUFPQyxjQUFjSixHQUNuQ0ssRUFBSSxFQUFHQSxFQUFJSixFQUFRM0IsT0FBUStC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QUNyQzJELFNBQVN1RixLQUFLQyxZQUFZaEIsRUFBU2EsWUFDbkNiLEVBQVNpQixXQUFZLEVBRXJCYixFQUFnQk0sUUFBUXJLLGFBQWUsRUFBR0gsY0FBZ0IsR0FDMURrSyxFQUFnQk8sY0FBY3hLLE9BQU95SyxrQkFDckNSLEVBQWdCUyxXQUFXQyxNQUFNakosU0FBVyxRQUM1Q3VJLEVBQWdCUyxXQUFXQyxNQUFNSSxJQUFNLEtBQ3ZDZCxFQUFnQlMsV0FBV0MsTUFBTWhHLEtBQU8sTUFDeENzRixFQUFnQlMsV0FBV0MsTUFBTUssT0FBUyxJQUMxQ2YsRUFBZ0JTLFdBQVdDLE1BQU1NLFFBQVUsY0FDM0M1RixTQUFTdUYsS0FBS0MsWUFBWVosRUFBZ0JTLFlBQzFDVCxFQUFnQmEsV0FBWSxFQUU1QlosRUFBY3hJLFNBQVNJLEVBQUlyQixnQkFDM0J5SixFQUFjeEUsU0FBU2pFLEdBQUssR0FBS3lDLEtBQUtDLEdBQUssSUFFM0NpRSxJQUdBckIsRUFBTTNDLElBQUluQixPQUFPVyxjQUNqQm1DLElBQ0E0RCxNQTFRYyIsImZpbGUiOiJidW5kbGUubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBbGwgY29uc3RhbnRzLCBhdmFpbGFibGUgaW4gZ2xvYmFsIHdpbmRvdy5cbiAqL1xuXG5jb25zdCBXT1JMRF9TSURFX1NJWkUgPSA3O1xuY29uc3QgV0lORE9XX0hFSUdIVCA9IHdpbmRvdy5pbm5lckhlaWdodDtcbmNvbnN0IFdJTkRPV19XSURUSCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuY29uc3QgUk9BRF9DT0xPUlMgPSBbXG4gICAgMHhmZjAwMDAsXG4gICAgMHhmZjg4MDAsXG4gICAgMHhmZmZmMDAsXG4gICAgMHgwMGZmMDAsXG4gICAgMHgwMGZmZmYsXG4gICAgMHgwMDAwZmYsXG4gICAgMHhmZjAwZmZcbl07XG5jb25zdCBOVU1CRVJfQ09MT1JTID0gUk9BRF9DT0xPUlMubGVuZ3RoO1xuY29uc3QgV09STERfSEVJR0hUID0gMTAwMDtcbmNvbnN0IFdPUkxEX1dJRFRIID0gMTAwO1xuY29uc3QgVE9QX0NBTUVSQV9ESVNUID0gNTA7XG5jb25zdCBDQVJfU0laRV9YID0gMTA7XG5jb25zdCBDQVJfU0laRV9ZID0gMTA7XG5jb25zdCBDQVJfU0laRV9aID0gMTA7XG5jb25zdCBCT1hfU0laRSA9IDEwO1xuIiwiLyoqXG4gKiBQaHlzaWNzIFwiZW5naW5lXCIgZm9yIHRoZSBnYW1lLlxuICogTm90UGh5c2lqcyBmb3IgTm90TWFyaW9LYXJ0LlxuICovXG5jb25zdCBQaHlzaWNzID0gKGZ1bmN0aW9uKCkge1xuXG4gICAgY29uc3QgZyA9IC0xO1xuICAgIGxldCBoZWxsID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgLVRPUF9DQU1FUkFfRElTVCwgMCk7XG4gICAgbGV0IG9uZURpcmVjdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDEsIDApO1xuICAgIGxldCByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7XG5cbiAgICBmdW5jdGlvbiBncmF2aXR5KG9iamVjdCwgZmxvb3IpIHtcbiAgICAgICAgLy8gVXBkYXRlIHJheWNhc3RlciB3aXRoIGFuIG9yaWdpbiBiZWxvdyB0aGUgb2JqZWN0LlxuICAgICAgICBoZWxsLnggPSBvYmplY3QucG9zaXRpb24ueDtcbiAgICAgICAgaGVsbC56ID0gb2JqZWN0LnBvc2l0aW9uLno7XG4gICAgICAgIHJheWNhc3Rlci5zZXQoaGVsbCwgb25lRGlyZWN0aW9uKTtcblxuICAgICAgICAvLyBUcnkgdG8gaW50ZXJzZWN0IHdpdGggZmxvb3IuXG4gICAgICAgIGxldCBpbnRlcnNlY3RzID0gcmF5Y2FzdGVyLmludGVyc2VjdE9iamVjdChmbG9vciwgdHJ1ZSk7XG4gICAgICAgIGlmICghaW50ZXJzZWN0cy5sZW5ndGggfHwgb2JqZWN0LnBvc2l0aW9uLnkgPCAwKSB7XG4gICAgICAgICAgICBvYmplY3QucG9zaXRpb24ueSArPSBnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZGV0ZWN0Q29sbGlzaW9uKGNhciwgb2JqZWN0cykge1xuICAgICAgICBsZXQgY2FyQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KGNhcik7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKGNhckJveC5pbnRlcnNlY3RzQm94KG9iamVjdHNbaV0uYm91bmRpbmdCb3gpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGdyYXZpdHk6IGdyYXZpdHksXG4gICAgICAgIGRldGVjdENvbGxpc2lvbjogZGV0ZWN0Q29sbGlzaW9uXG4gICAgfTtcbn0pKCk7XG4iLCIvKipcbiAqIEJveGVzIHJlcHJlc2VudGluZyBvYnN0YWNsZXMuXG4gKi9cbmNvbnN0IEJveCA9IChmdW5jdGlvbih4LCB5LCB6KSB7XG4gICAgbGV0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KCBCT1hfU0laRSwgQk9YX1NJWkUsIEJPWF9TSVpFICk7XG4gICAgbGV0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKCB7Y29sb3I6IDB4YWE4ODQ0fSApO1xuICAgIHRoaXMubWVzaCA9IG5ldyBUSFJFRS5NZXNoKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTtcbiAgICB0aGlzLm1lc2gucG9zaXRpb24ueCA9IHg7XG4gICAgdGhpcy5tZXNoLnBvc2l0aW9uLnkgPSB5O1xuICAgIHRoaXMubWVzaC5wb3NpdGlvbi56ID0gejtcbiAgICB0aGlzLmJvdW5kaW5nQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KHRoaXMubWVzaCk7XG59KTtcbiIsIi8qKlxuICogRXZlcnl0aGluZyBhYm91dCB0aGUgUGxheWVyIG9iamVjdCwgaXRzIGNhbWVyYSwgdGhlIG1vdmVtZW50cyAuLi5cbiAqL1xuXG5jb25zdCBQbGF5ZXIgPSAoZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgcG92Q2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKFxuICAgICAgICA3NSxcbiAgICAgICAgV0lORE9XX1dJRFRIIC8gV0lORE9XX0hFSUdIVCxcbiAgICAgICAgMC4xLFxuICAgICAgICAxMDAwXG4gICAgKTtcblxuICAgIGNvbnN0IHRyYWNraW5nQ2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKFxuICAgICAgICA3NSxcbiAgICAgICAgV0lORE9XX1dJRFRIIC8gV0lORE9XX0hFSUdIVCxcbiAgICAgICAgMC4xLFxuICAgICAgICAxMDAwXG4gICAgKTtcblxuICAgIGxldCBjdXJyZW50Q2FtZXJhID0gdHJhY2tpbmdDYW1lcmE7XG4gICAgbGV0IGdldENhbWVyYSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gY3VycmVudENhbWVyYTtcbiAgICB9O1xuXG4gICAgY29uc3QgcGxheWVyT2JqZWN0ID0gbWFrZVBsYXllck9iamVjdCgpO1xuICAgIHZhciBwbGF5ZXJJZCA9IG51bGw7XG5cbiAgICBjb25zdCBjb250cm9scyA9IHtcbiAgICAgICAgbW92ZW1lbnQ6IHtcbiAgICAgICAgICAgIGFycm93czoge1xuICAgICAgICAgICAgICAgIHVwOiAzOCxcbiAgICAgICAgICAgICAgICBkb3duOiA0MCxcbiAgICAgICAgICAgICAgICBsZWZ0OiAzNyxcbiAgICAgICAgICAgICAgICByaWdodDogMzlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB3YXNkOiB7XG4gICAgICAgICAgICAgICAgdXA6IDg3LFxuICAgICAgICAgICAgICAgIGRvd246IDgzLFxuICAgICAgICAgICAgICAgIGxlZnQ6IDY1LFxuICAgICAgICAgICAgICAgIHJpZ2h0OiA2OFxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzd2l0Y2hDYW1lcmE6IDY3LFxuICAgICAgICByZXNldDogOFxuICAgIH07XG5cbiAgICBsZXQgZW5hYmxlZENvbnRyb2xzID0gY29udHJvbHMubW92ZW1lbnQuYXJyb3dzO1xuXG4gICAgbGV0IHNwZWVkID0gMDtcbiAgICBsZXQgbWF4U3BlZWQgPSA1O1xuICAgIGNvbnN0IGFjY2VsZXJhdGlvbiA9IDAuMDU7XG4gICAgY29uc3Qgcm90YXRpb25TcGVlZCA9IDAuMDU7XG5cbiAgICBjb25zdCBrZXlDb2RlTWFwID0ge307XG5cbiAgICBmdW5jdGlvbiBvbktleU1vdmUoZSkge1xuICAgICAgICBlID0gZSB8fCBldmVudDsgLy8gRm9yIElFLlxuICAgICAgICBrZXlDb2RlTWFwW2Uud2hpY2hdID0gZS50eXBlID09PSAna2V5ZG93bic7XG4gICAgfVxuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIG9uS2V5TW92ZSwgZmFsc2UpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgb25LZXlNb3ZlLCBmYWxzZSk7XG5cbiAgICBmdW5jdGlvbiBkb01vdmVtZW50TG9vcCgpIHtcbiAgICAgICAgaWYgKGtleUNvZGVNYXBbZW5hYmxlZENvbnRyb2xzLnVwXSkge1xuICAgICAgICAgICAgaWYgKHNwZWVkIDwgbWF4U3BlZWQpIHtcbiAgICAgICAgICAgICAgICBzcGVlZCArPSBhY2NlbGVyYXRpb247XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGtleUNvZGVNYXBbZW5hYmxlZENvbnRyb2xzLmxlZnRdKSB7XG4gICAgICAgICAgICBwbGF5ZXJPYmplY3Qucm90YXRlWShyb3RhdGlvblNwZWVkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5Q29kZU1hcFtlbmFibGVkQ29udHJvbHMucmlnaHRdKSB7XG4gICAgICAgICAgICBwbGF5ZXJPYmplY3Qucm90YXRlWSgtcm90YXRpb25TcGVlZCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGtleUNvZGVNYXBbZW5hYmxlZENvbnRyb2xzLmRvd25dKSB7XG4gICAgICAgICAgICBpZiAoc3BlZWQgPiAwKSB7XG4gICAgICAgICAgICAgICAgc3BlZWQgLT0gYWNjZWxlcmF0aW9uO1xuICAgICAgICAgICAgICAgIHNwZWVkID0gTWF0aC5tYXgoMCwgc3BlZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHBsYXllck9iamVjdC50cmFuc2xhdGVaKHNwZWVkKTtcbiAgICAgICAgaWYgKGtleUNvZGVNYXBbY29udHJvbHMuc3dpdGNoQ2FtZXJhXSkge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRDYW1lcmEgPT09IHBvdkNhbWVyYSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRDYW1lcmEgPSB0cmFja2luZ0NhbWVyYTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY3VycmVudENhbWVyYSA9IHBvdkNhbWVyYTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGtleUNvZGVNYXBbY29udHJvbHMuc3dpdGNoQ2FtZXJhXSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChrZXlDb2RlTWFwW2NvbnRyb2xzLnJlc2V0XSkge1xuICAgICAgICAgICAgcGxheWVyT2JqZWN0LnJvdGF0aW9uLnggPSAwO1xuICAgICAgICAgICAgcGxheWVyT2JqZWN0LnBvc2l0aW9uLnNldCgwLCBwbGF5ZXJPYmplY3QucG9zaXRpb24ueCwgMCk7XG4gICAgICAgICAgICBwbGF5ZXJPYmplY3Qucm90YXRpb24ueSA9IDA7XG4gICAgICAgICAgICBwbGF5ZXJPYmplY3QucG9zaXRpb24uc2V0KDAsIHBsYXllck9iamVjdC5wb3NpdGlvbi55LCAwKTtcbiAgICAgICAgICAgIHBsYXllck9iamVjdC5yb3RhdGlvbi56ID0gMDtcbiAgICAgICAgICAgIHBsYXllck9iamVjdC5wb3NpdGlvbi5zZXQoMCwgcGxheWVyT2JqZWN0LnBvc2l0aW9uLnosIDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY3Jhc2goKSB7XG4gICAgICAgIC8vIGFjY2VsZXJhdGlvbiA9IDA7XG4gICAgICAgIHNwZWVkID0gMDtcbiAgICAgICAgLy8gaWYgKGtleUNvZGVNYXBbZW5hYmxlZENvbnRyb2xzLnVwXSkge1xuICAgICAgICAvLyAgICAgcGxheWVyT2JqZWN0LnRyYW5zbGF0ZVooLXNwZWVkKTtcbiAgICAgICAgLy8gfSBlbHNlIHtcbiAgICAgICAgLy8gICAgIHBsYXllck9iamVjdC50cmFuc2xhdGVaKHNwZWVkKTtcbiAgICAgICAgLy8gfVxuXG4gICAgICAgIC8vIGZvciAodmFyIGkgPSBncm91cEJsb2Nrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAvLyBsZXQgcG9zID0gZ3JvdXBCbG9ja3NbaV0ucG9zaXRpb247XG4gICAgICAgIC8vICAgICBsZXQgcG8gPSBwbGF5ZXJPYmplY3QuY2hpbGRyZW5bMl0uY2hpbGRyZW5bMF1cbiAgICAgICAgLy8gZm9yICh2YXIgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHBvLmdlb21ldHJ5LnZlcnRpY2VzLmxlbmd0aDsgdmVydGV4SW5kZXgrKylcbiAgICAgICAgLy8ge1xuICAgICAgICAvLyAgICAgdmFyIGxvY2FsVmVydGV4ID0gcG8uZ2VvbWV0cnkudmVydGljZXNbdmVydGV4SW5kZXhdLmNsb25lKCk7XG4gICAgICAgIC8vICAgICB2YXIgZ2xvYmFsVmVydGV4ID0gbG9jYWxWZXJ0ZXguYXBwbHlNYXRyaXhwbGF5ZXJPYmplY3QubWF0cml4Lm11bHRpcGx5VmVjdG9yMygpO1xuICAgICAgICAvLyAgICAgdmFyIGRpcmVjdGlvblZlY3RvciA9IGdsb2JhbFZlcnRleC5zdWJTZWxmKCBwby5wb3NpdGlvbiApO1xuXG4gICAgICAgIC8vICAgICB2YXIgcmF5ID0gbmV3IFRIUkVFLlJheSggcG8ucG9zaXRpb24sIGRpcmVjdGlvblZlY3Rvci5jbG9uZSgpLm5vcm1hbGl6ZSgpICk7XG4gICAgICAgIC8vICAgICB2YXIgY29sbGlzaW9uUmVzdWx0cyA9IHJheS5pbnRlcnNlY3RPYmplY3RzKCBncm91cEJsb2NrcyApO1xuICAgICAgICAvLyAgICAgaWYgKCBjb2xsaXNpb25SZXN1bHRzLmxlbmd0aCA+IDAgJiYgY29sbGlzaW9uUmVzdWx0c1swXS5kaXN0YW5jZSA8IGRpcmVjdGlvblZlY3Rvci5sZW5ndGgoKSApXG4gICAgICAgIC8vICAgICB7XG4gICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coJ3BlcmRpc3RyZScpXG4gICAgICAgIC8vICAgICAgICAgLy8gYSBjb2xsaXNpb24gb2NjdXJyZWQuLi4gZG8gc29tZXRoaW5nLi4uXG4gICAgICAgIC8vICAgICB9XG4gICAgICAgIC8vIH1cbiAgICAgICAgLy8gaWYoKHBsYXllck9iamVjdC5wb3NpdGlvbi54KzUgPCBwb3MueCAmJiBwbGF5ZXJPYmplY3QucG9zaXRpb24ueis1IDwgcG9zLnopfHwgKHBsYXllck9iamVjdC5wb3NpdGlvbi54LTUgPiBwb3MueCAmJiBwbGF5ZXJPYmplY3QucG9zaXRpb24ueis1ID4gcG9zLnopKVxuICAgICAgICAvLyBjb25zb2xlLmxvZyhncm91cEJsb2Nrc1tpXSlcbiAgICAgICAgLy8gfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIG1ha2VQbGF5ZXJPYmplY3QoKSB7XG4gICAgICAgIGNvbnN0IGxvYWRlciA9IG5ldyBUSFJFRS5PYmplY3RMb2FkZXIoKTtcbiAgICAgICAgY29uc3Qgb2JqZWN0ID0gbG9hZGVyLnBhcnNlKHBsYXllckNhcik7XG5cbiAgICAgICAgcG92Q2FtZXJhLnBvc2l0aW9uLnkgPSBvYmplY3Quc2NhbGUueSAqIDI7XG4gICAgICAgIHBvdkNhbWVyYS5wb3NpdGlvbi56ID0gb2JqZWN0LnNjYWxlLnogKiA0O1xuICAgICAgICAvLyB0cmFja2luZ0NhbWVyYS5yb3RhdGVYKDAgKiBNYXRoLlBJIC8gMTgwKTtcbiAgICAgICAgcG92Q2FtZXJhLnJvdGF0ZVkoMTgwICogTWF0aC5QSSAvIDE4MCk7XG5cbiAgICAgICAgdHJhY2tpbmdDYW1lcmEucG9zaXRpb24ueSA9IG9iamVjdC5zY2FsZS55ICogMTA7XG4gICAgICAgIHRyYWNraW5nQ2FtZXJhLnBvc2l0aW9uLnogPSBvYmplY3Quc2NhbGUueiAqIC0yMDtcbiAgICAgICAgLy8gdHJhY2tpbmdDYW1lcmEucm90YXRlWCgwICogTWF0aC5QSSAvIDE4MCk7XG4gICAgICAgIHRyYWNraW5nQ2FtZXJhLnJvdGF0ZVkoMTgwICogTWF0aC5QSSAvIDE4MCk7XG5cbiAgICAgICAgb2JqZWN0LmFkZChwb3ZDYW1lcmEpO1xuICAgICAgICBvYmplY3QuYWRkKHRyYWNraW5nQ2FtZXJhKTtcblxuICAgICAgICByZXR1cm4gb2JqZWN0O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGRvTW92ZW1lbnRMb29wOiBkb01vdmVtZW50TG9vcCxcbiAgICAgICAgcGxheWVyT2JqZWN0OiBwbGF5ZXJPYmplY3QsXG4gICAgICAgIGdldENhbWVyYTogZ2V0Q2FtZXJhLFxuICAgICAgICBwbGF5ZXJJZDogcGxheWVySWQsXG4gICAgICAgIGNyYXNoOiBjcmFzaFxuICAgIH07XG59KSgpO1xuIiwiLyoqXG4gKiBNYWluIGZpbGUgb2YgdGhlIGdhbWUuXG4gKi9cblxuY29uc3QgTm90TWFyaW9LYXJ0ID0gKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcigpO1xuICAgIGNvbnN0IG1pbmlNYXBSZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKCk7XG4gICAgY29uc3QgbWluaU1hcENhbWVyYSA9IG5ldyBUSFJFRS5PcnRob2dyYXBoaWNDYW1lcmEoXG4gICAgICAgIC1XSU5ET1dfV0lEVEgsXG4gICAgICAgIFdJTkRPV19XSURUSCxcbiAgICAgICAgV0lORE9XX0hFSUdIVCxcbiAgICAgICAgLVdJTkRPV19IRUlHSFQsXG4gICAgICAgIFRPUF9DQU1FUkFfRElTVCAtIDUwLFxuICAgICAgICBUT1BfQ0FNRVJBX0RJU1QgKyA1MFxuICAgICk7XG4gICAgdmFyIGZsb29yO1xuICAgIC8vQm94IG9iamVjdHNcbiAgICB2YXIgb2JqZWN0cyA9IFtdO1xuICAgIGNvbnN0IHBsYXllcnMgPSB7fTtcbiAgICAvL0JveCBwb3NpdGlvbnMgZm9yIG90aGVyIHBsYXllcnNcbiAgICB2YXIgYm94ZXMgPSBbXTtcblxuICAgIGZ1bmN0aW9uIGluaXRTb2NrZXRFdmVudCgpIHtcbiAgICAgICAgdmFyIHNvY2tldCA9IGlvKHsgdHJhbnNwb3J0czogWyd3ZWJzb2NrZXQnXSwgdXBncmFkZTogZmFsc2UgfSk7XG5cbiAgICAgICAgLy8gVE9ETzogc2hvdyBtb2RhbCB3aXRoIG5hbWUgZm9ybSwgdGhlbiBlbWl0IG5hbWVcblxuICAgICAgICBzb2NrZXQub24oJ2FsbC1wbGF5ZXJzJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1thbGwtcGxheWVyc10nLCBkYXRhKTtcbiAgICAgICAgICAgIGRhdGEuZm9yRWFjaChmdW5jdGlvbihwbGF5ZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSBwbGF5ZXIucG9zaXRpb247XG4gICAgICAgICAgICAgICAgY29uc3Qgcm90ID0gcGxheWVyLnJvdGF0aW9uO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhciA9IG1ha2VDYXJPYmplY3QoKTtcbiAgICAgICAgICAgICAgICBwbGF5ZXJzW3BsYXllci5pZF0gPSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBwb3MsXG4gICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uOiByb3QsXG4gICAgICAgICAgICAgICAgICAgIGNhcjogY2FyXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBjYXIucG9zaXRpb24uc2V0KHBvcy54LCBwb3MueSwgcG9zLnopO1xuICAgICAgICAgICAgICAgIGNhci5yb3RhdGlvbi5zZXQocm90LngsIHJvdC55LCByb3Queik7XG4gICAgICAgICAgICAgICAgc2NlbmUuYWRkKGNhcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgaWYoZGF0YS5sZW5ndGggPT0gMCl7XG4gICAgICAgICAgICAgICAgYWRkQm94ZXMoKTtcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnc2VuZC1ib3hlcycsYm94ZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oJ3BsYXllci1qb2luZWQnLCBmdW5jdGlvbihwbGF5ZXIpIHtcbiAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKGBwbGF5ZXIgJHtwbGF5ZXIuaWR9IGhhcyBqb2luZWQuYCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW3BsYXllci1qb2luZWRdJywgcGxheWVyKTtcbiAgICAgICAgICAgIGNvbnN0IHBvcyA9IHBsYXllci5wb3NpdGlvbjtcbiAgICAgICAgICAgIGNvbnN0IHJvdCA9IHBsYXllci5yb3RhdGlvbjtcbiAgICAgICAgICAgIGNvbnN0IGNhciA9IG1ha2VDYXJPYmplY3QoKTtcbiAgICAgICAgICAgIHBsYXllcnNbcGxheWVyLmlkXSA9IHtcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogcG9zLFxuICAgICAgICAgICAgICAgIHJvdGF0aW9uOiByb3QsXG4gICAgICAgICAgICAgICAgY2FyOiBjYXJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjYXIucG9zaXRpb24uc2V0KHBvcy54LCBwb3MueSwgcG9zLnopO1xuICAgICAgICAgICAgY2FyLnJvdGF0aW9uLnNldChyb3QueCwgcm90LnksIHJvdC56KTtcbiAgICAgICAgICAgIHNjZW5lLmFkZChjYXIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oJ3JlY2VpdmUtYm94ZXMnLCBmdW5jdGlvbihib3hzKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnW3BsYXllci1sZWZ0XScsIHBsYXllcklkKTtcbiAgICAgICAgICAgIGJveGVzID0gYm94cztcbiAgICAgICAgICAgIGFkZEJveGVzUG9zaXRpb24oKTtcbiAgICAgICAgICAgIC8vIGNvbnN0IGNhciA9IHBsYXllcnNbcGxheWVySWRdLi8vY2FyO1xuICAgICAgICAgICAgLy8gc2NlbmUucmVtb3ZlKGNhcik7XG4gICAgICAgICAgICAvLyBkZWxldGUgcGxheWVyc1twbGF5ZXJJZF07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldC5vbigncGxheWVyLWxlZnQnLCBmdW5jdGlvbihwbGF5ZXJJZCkge1xuICAgICAgICAgICAgdG9hc3RyLmVycm9yKGBQbGF5ZXIgJHtwbGF5ZXJJZH0gaGFzIGxlZnQuYCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW3BsYXllci1sZWZ0XScsIHBsYXllcklkKTtcbiAgICAgICAgICAgIGNvbnN0IGNhciA9IHBsYXllcnNbcGxheWVySWRdLmNhcjtcbiAgICAgICAgICAgIHNjZW5lLnJlbW92ZShjYXIpO1xuICAgICAgICAgICAgZGVsZXRlIHBsYXllcnNbcGxheWVySWRdO1xuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oJ3VwZGF0ZS1wbGF5ZXInLCBmdW5jdGlvbihwbGF5ZXIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbdXBkYXRlLXBsYXllcl0nLCBwbGF5ZXIpO1xuICAgICAgICAgICAgY29uc3QgaWQgPSBwbGF5ZXIuaWQ7XG4gICAgICAgICAgICBjb25zdCBwb3MgPSBwbGF5ZXIucG9zaXRpb247XG4gICAgICAgICAgICBjb25zdCByb3QgPSBwbGF5ZXIucm90YXRpb247XG4gICAgICAgICAgICBjb25zdCBwID0gcGxheWVyc1tpZF07XG4gICAgICAgICAgICBwLmNhci5wb3NpdGlvbi5zZXQocG9zLngsIHBvcy55LCBwb3Mueik7XG4gICAgICAgICAgICBwLmNhci5yb3RhdGlvbi5zZXQocm90LngsIHJvdC55LCByb3Queik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldC5vbignc3RhcnQtY291bnRkb3duJywgZnVuY3Rpb24oc2Vjb25kcykge1xuICAgICAgICAgICAgdG9hc3RyLmluZm8oYCR7c2Vjb25kc30gc2Vjb25kcyBiZWZvcmUgdGhlIHJhY2Ugc3RhcnRzLmApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tzdGFydC1jb3VudGRvd25dJywgc2Vjb25kcyk7XG4gICAgICAgICAgICAvLyBUT0RPOiBzaG93IFwieCBzZWNvbmRzIGJlZm9yZSBzdGFydFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldC5vbignc3RhcnQnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHRvYXN0ci5pbmZvKCdUaGUgcmFjZSBoYXMgc3RhcnRlZC4nKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbc3RhcnRdJyk7XG4gICAgICAgICAgICAvLyBUT0RPOiBub3RpZnkgdGhlIGdhbWUgaGFzIHN0YXJ0ZWRcbiAgICAgICAgICAgIC8vIFRPRE86IGRpc2FibGUgbW92aW5nIGlmIG5vdCBzdGFydGVkXG4gICAgICAgICAgICAvLyBUT0RPOiBldmVyeW9uZSBuZWVkcyBhIG5hbWUgZmlyc3QgKGRvbid0IGhpZGUgbW9kYWwpXG4gICAgICAgICAgICAvLyBUT0RPOiBldmVyeW9uZSBuZWVkcyB0byBiZSByZWFkeVxuICAgICAgICAgICAgLy8gVE9ETzogMisgcGxheWVyc1xuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oJ2ZpbmlzaGVkJywgZnVuY3Rpb24odGltZSkge1xuICAgICAgICAgICAgdG9hc3RyLmluZm8oJ1lvdSBmaW5pc2hlZC4nKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbZmluaXNoZWRdJywgdGltZSk7XG4gICAgICAgICAgICAvLyBUT0RPOiBzaG93IG1vZGFsIFwid2FpdGluZyBmb3Igb3RoZXJzLCB5b3VyIHRpbWUgaXMgeFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldC5vbignc3RvcCcsIGZ1bmN0aW9uKHBsYXllcnMpIHtcbiAgICAgICAgICAgIHRvYXN0ZXIuaW5mbygnVGhlIHJhY2UgaXMgb3Zlci4nKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbc3RvcF0nLCBzdG9wKTtcbiAgICAgICAgICAgIC8vIFRPRE86IGFsbCBwbGF5ZXJzIGFyZSBmaW5pc2hlZCwgc2hvdyByYW5raW5nIGFuZCBwbGF5IGFnYWluIGJ1dHRvblxuICAgICAgICAgICAgcGxheWVycy5mb3JFYWNoKGZ1bmN0aW9uKHBsYXllcikge1xuICAgICAgICAgICAgICAgIC8vIHNvcnRlZCBieSByYW5raW5nIDotKVxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBwbGF5ZXIubmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCB0aW1lID0gdGltZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBjb25zdCBwID0gUGxheWVyLnBsYXllck9iamVjdDtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KCd1cGRhdGUtcGxheWVyJywge1xuICAgICAgICAgICAgICAgIHBvc2l0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgIHg6IHAucG9zaXRpb24ueCxcbiAgICAgICAgICAgICAgICAgICAgeTogcC5wb3NpdGlvbi55LFxuICAgICAgICAgICAgICAgICAgICB6OiBwLnBvc2l0aW9uLnpcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJvdGF0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgIHg6IHAucm90YXRpb24uX3gsXG4gICAgICAgICAgICAgICAgICAgIHk6IHAucm90YXRpb24uX3ksXG4gICAgICAgICAgICAgICAgICAgIHo6IHAucm90YXRpb24uX3pcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSwgMTAwMCAvIDI1KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBtYWtlQ2FyT2JqZWN0KCkge1xuICAgICAgICBjb25zdCBsb2FkZXIgPSBuZXcgVEhSRUUuT2JqZWN0TG9hZGVyKCk7XG4gICAgICAgIGNvbnN0IG9iamVjdCA9IGxvYWRlci5wYXJzZShwbGF5ZXJDYXIpO1xuICAgICAgICByZXR1cm4gb2JqZWN0O1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGJ1aWxkRmxvb3IoKSB7XG4gICAgICAgIGxldCBjdXJ2ZSA9IG5ldyBUSFJFRS5DYXRtdWxsUm9tQ3VydmUzKFtcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgNTAwLCAwKSxcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IzKC0yMDAsIDUwMCwgMCksXG4gICAgICAgICAgICBuZXcgVEhSRUUuVmVjdG9yMygtMjAwLCA4MDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoNjAwLCA4MDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoNjAwLCA1MDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMzAwLCA1MDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMzAwLCAwLCAwKSxcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IzKDgwMCwgMCwgMCksXG4gICAgICAgICAgICBuZXcgVEhSRUUuVmVjdG9yMyg4MDAsIC01MDAsIDApLFxuICAgICAgICAgICAgbmV3IFRIUkVFLlZlY3RvcjMoMCwgLTUwMCwgMClcbiAgICAgICAgXSk7XG4gICAgICAgIGN1cnZlLmNsb3NlZCA9IHRydWU7XG5cbiAgICAgICAgbGV0IGV4dHJ1ZGVTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIHN0ZXBzOiAxMDAsXG4gICAgICAgICAgICBleHRydWRlUGF0aDogY3VydmVcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBTaGFwZSB0aGF0IGdldHMgZXh0cnVkZWQgdGhyb3VnaCB0aGUgY3VydmVcbiAgICAgICAgbGV0IHNoYXBlID0gbmV3IFRIUkVFLlNoYXBlKFtcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IyKDIgKiBDQVJfU0laRV9ZLCAwKSxcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IyKDAsIDUgKiBDQVJfU0laRV9YKSxcbiAgICAgICAgICAgIG5ldyBUSFJFRS5WZWN0b3IyKDAsIC01ICogQ0FSX1NJWkVfWClcbiAgICAgICAgXSk7XG5cbiAgICAgICAgdmFyIGdlb21ldHJ5ID0gbmV3IFRIUkVFLkV4dHJ1ZGVHZW9tZXRyeShzaGFwZSwgZXh0cnVkZVNldHRpbmdzKTtcblxuICAgICAgICBsZXQgbWF0ZXJpYWxzID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNQkVSX0NPTE9SUzsgaSsrKSB7XG4gICAgICAgICAgICBtYXRlcmlhbHMucHVzaChcbiAgICAgICAgICAgICAgICBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoe1xuICAgICAgICAgICAgICAgICAgICBjb2xvcjogUk9BRF9DT0xPUlNbaV0sXG4gICAgICAgICAgICAgICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsXG4gICAgICAgICAgICAgICAgICAgIC8vd2lyZWZyYW1lOiB0cnVlIC8vIFRoaXMgbWFrZXMgdHJhY2sgbW9yZSBUcm9uLWxpa2VcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBnZW9GYWNlc0xlbmd0aCA9IGdlb21ldHJ5LmZhY2VzLmxlbmd0aCAvIDI7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2VvRmFjZXNMZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGogPSBpICogMjsgLy8gPC0tIEFkZGVkIHRoaXMgYmFjayBzbyB3ZSBjYW4gZG8gZXZlcnkgb3RoZXIgJ2ZhY2UnXG5cbiAgICAgICAgICAgIGdlb21ldHJ5LmZhY2VzW2pdLm1hdGVyaWFsSW5kZXggPVxuICAgICAgICAgICAgICAgIChpICsgTWF0aC5mbG9vcihpIC8gV09STERfU0lERV9TSVpFKSkgJSBOVU1CRVJfQ09MT1JTO1xuXG4gICAgICAgICAgICBnZW9tZXRyeS5mYWNlc1tqICsgMV0ubWF0ZXJpYWxJbmRleCA9XG4gICAgICAgICAgICAgICAgKGkgKyBNYXRoLmZsb29yKGkgLyBXT1JMRF9TSURFX1NJWkUpKSAlIE5VTUJFUl9DT0xPUlM7IC8vIE90aGVyIGhhbGYgb2YgdGhlIHNhbWUgZmFjZVxuICAgICAgICB9XG5cbiAgICAgICAgZmxvb3IgPSBuZXcgVEhSRUUuTWVzaChnZW9tZXRyeSwgbWF0ZXJpYWxzKTtcbiAgICAgICAgZmxvb3Iucm90YXRlWCgtTWF0aC5QSSAvIDIpO1xuICAgICAgICBmbG9vci5wb3NpdGlvbi55ID0gMDtcblxuICAgICAgICBzY2VuZS5hZGQoZmxvb3IpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGFkZEJveGVzKCkge1xuICAgICAgICBsZXQgbWluID0gLTIwMDA7XG4gICAgICAgIGxldCBtYXggPSAgMjAwMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHtcbiAgICAgICAgICAgIC8vIENyZWF0ZSByYW5kb20gYm94LlxuICAgICAgICAgICAgbGV0IGJveCA9IG5ldyBCb3goTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKChtYXgtbWluKSsxKSArIG1pbiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCT1hfU0laRS8yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKChtYXgtbWluKSsxKSArIG1pbikpO1xuICAgICAgICAgICAgLy8gQWRkIG9ubHkgaWYgaXQncyBvdmVyIHRoZSBmbG9vci5cbiAgICAgICAgICAgIHNjZW5lLnVwZGF0ZU1hdHJpeFdvcmxkKCk7XG4gICAgICAgICAgICBQaHlzaWNzLmdyYXZpdHkoYm94Lm1lc2gsIGZsb29yKTtcbiAgICAgICAgICAgIGlmIChib3gubWVzaC5wb3NpdGlvbi55ID09IEJPWF9TSVpFLzIpIHtcbiAgICAgICAgICAgICAgICBvYmplY3RzLnB1c2goYm94KTtcbiAgICAgICAgICAgICAgICBib3hlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgeDogYm94Lm1lc2gucG9zaXRpb24ueCxcbiAgICAgICAgICAgICAgICAgICAgejogYm94Lm1lc2gucG9zaXRpb24uelxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHNjZW5lLmFkZChib3gubWVzaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBhZGRCb3hlc1Bvc2l0aW9uKCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJveGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgcmFuZG9tIGJveC5cbiAgICAgICAgICAgIGxldCBib3ggPSBuZXcgQm94KGJveGVzW2ldLngsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCT1hfU0laRS8yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94ZXNbaV0ueik7XG4gICAgICAgICAgICAvLyBBZGQgb25seSBpZiBpdCdzIG92ZXIgdGhlIGZsb29yLlxuICAgICAgICAgICAgc2NlbmUudXBkYXRlTWF0cml4V29ybGQoKTtcbiAgICAgICAgICAgIFBoeXNpY3MuZ3Jhdml0eShib3gubWVzaCwgZmxvb3IpO1xuICAgICAgICAgICAgaWYgKGJveC5tZXNoLnBvc2l0aW9uLnkgPT0gQk9YX1NJWkUvMikge1xuICAgICAgICAgICAgICAgIG9iamVjdHMucHVzaChib3gpO1xuICAgICAgICAgICAgICAgIHNjZW5lLmFkZChib3gubWVzaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBpbml0KCkge1xuICAgICAgICByZW5kZXJlci5zZXRTaXplKFdJTkRPV19XSURUSCwgV0lORE9XX0hFSUdIVCk7XG4gICAgICAgIHJlbmRlcmVyLnNldFBpeGVsUmF0aW8od2luZG93LmRldmljZVBpeGVsUmF0aW8pO1xuICAgICAgICByZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJztcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChyZW5kZXJlci5kb21FbGVtZW50KTtcbiAgICAgICAgcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7XG5cbiAgICAgICAgbWluaU1hcFJlbmRlcmVyLnNldFNpemUoV0lORE9XX1dJRFRIIC8gNCwgV0lORE9XX0hFSUdIVCAvIDQpO1xuICAgICAgICBtaW5pTWFwUmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyh3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7XG4gICAgICAgIG1pbmlNYXBSZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJztcbiAgICAgICAgbWluaU1hcFJlbmRlcmVyLmRvbUVsZW1lbnQuc3R5bGUudG9wID0gJzUlJztcbiAgICAgICAgbWluaU1hcFJlbmRlcmVyLmRvbUVsZW1lbnQuc3R5bGUubGVmdCA9ICc3MCUnO1xuICAgICAgICBtaW5pTWFwUmVuZGVyZXIuZG9tRWxlbWVudC5zdHlsZS56SW5kZXggPSAnMic7XG4gICAgICAgIG1pbmlNYXBSZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLm91dGxpbmUgPSAnd2hpdGUgc29saWQnO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1pbmlNYXBSZW5kZXJlci5kb21FbGVtZW50KTtcbiAgICAgICAgbWluaU1hcFJlbmRlcmVyLmF1dG9DbGVhciA9IGZhbHNlO1xuXG4gICAgICAgIG1pbmlNYXBDYW1lcmEucG9zaXRpb24ueSA9IFRPUF9DQU1FUkFfRElTVDtcbiAgICAgICAgbWluaU1hcENhbWVyYS5yb3RhdGlvbi54ID0gLTkwICogTWF0aC5QSSAvIDE4MDtcblxuICAgICAgICBidWlsZEZsb29yKCk7XG4gICAgICAgIC8vIGFkZEJveGVzKCk7XG5cbiAgICAgICAgc2NlbmUuYWRkKFBsYXllci5wbGF5ZXJPYmplY3QpO1xuICAgICAgICBpbml0U29ja2V0RXZlbnQoKTtcbiAgICAgICAgbG9vcCgpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGxvb3AoKSB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKTtcblxuICAgICAgICByZW5kZXJlci5jbGVhcigpO1xuICAgICAgICByZW5kZXJlci5zZXRWaWV3cG9ydCgwLCAwLCBXSU5ET1dfV0lEVEgsIFdJTkRPV19IRUlHSFQpO1xuICAgICAgICByZW5kZXJlci5yZW5kZXIoc2NlbmUsIFBsYXllci5nZXRDYW1lcmEoKSk7XG5cbiAgICAgICAgbWluaU1hcFJlbmRlcmVyLmNsZWFyKCk7XG4gICAgICAgIG1pbmlNYXBSZW5kZXJlci5zZXRWaWV3cG9ydCgwLCAwLCBXSU5ET1dfV0lEVEggLyA0LCBXSU5ET1dfSEVJR0hUIC8gNCk7XG4gICAgICAgIG1pbmlNYXBSZW5kZXJlci5yZW5kZXIoc2NlbmUsIG1pbmlNYXBDYW1lcmEpO1xuXG4gICAgICAgIC8vIGZvciAobGV0IGlkIGluIHBsYXllcnMpIHtcbiAgICAgICAgLy8gICAgIGNvbnN0IHAgPSBwbGF5ZXJzW2lkXTtcbiAgICAgICAgLy8gICAgIGNvbnN0IHBvcyA9IHAucG9zaXRpb247XG4gICAgICAgIC8vICAgICBjb25zdCByb3QgPSBwLnJvdGF0aW9uO1xuICAgICAgICAvLyAgICAgcC5jYXIucG9zaXRpb24uc2V0KHBvcy54LCBwb3MueSwgcG9zLnopO1xuICAgICAgICAvLyAgICAgcC5jYXIucm90YXRpb24uc2V0KHJvdC54LCByb3QueSwgcm90LnopO1xuICAgICAgICAvLyB9XG5cbiAgICAgICAgUGxheWVyLmRvTW92ZW1lbnRMb29wKCk7XG4gICAgICAgIGlmIChQaHlzaWNzLmRldGVjdENvbGxpc2lvbihQbGF5ZXIucGxheWVyT2JqZWN0LCBvYmplY3RzKSkge1xuICAgICAgICAgICAgUGxheWVyLmNyYXNoKCk7XG4gICAgICAgIH1cbiAgICAgICAgbWluaU1hcENhbWVyYS5wb3NpdGlvbi56ID0gUGxheWVyLnBsYXllck9iamVjdC5wb3NpdGlvbi56O1xuXG4gICAgICAgIFBoeXNpY3MuZ3Jhdml0eShQbGF5ZXIucGxheWVyT2JqZWN0LCBmbG9vcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaW5pdDogaW5pdFxuICAgIH07XG59KSgpO1xuIl19
